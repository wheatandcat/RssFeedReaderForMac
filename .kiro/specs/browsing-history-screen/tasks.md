# Implementation Plan

## browsing-history-screen

---

- [ ] 1. 閲覧履歴のデータモデルと永続化層を作成する
- [x] 1.1 閲覧履歴エントリのモデルを作成する
  - 記事1件分の閲覧履歴を表す値型を定義し、JSON での保存・読み込みができるようにする
  - 記事の識別子・タイトル・リンクURL・フィード名・閲覧日時のフィールドを持たせる
  - `Identifiable` に準拠し、識別子フィールドを `id` として公開する
  - _Requirements: 1.1, 1.2_

- [x] 1.2 閲覧履歴の集合モデルを作成する
  - 閲覧履歴エントリの配列と最終更新日時を保持するコンテナモデルを定義する
  - JSON でのシリアライズ・デシリアライズに対応させる
  - デフォルト値として空の配列と現在日時を設定する
  - _Requirements: 1.4, 1.5_

- [x] 1.3 閲覧履歴の永続化リポジトリを実装する
  - `"history-store.v1"` をキーとして UserDefaults への読み込みと書き込みを担当するクラスを作成する
  - デコードに失敗した場合は空の閲覧履歴を返すフェイルセーフ動作を実装する
  - `SeenStoreRepository` と同じ責務分担パターンを踏襲する
  - _Requirements: 1.4, 5.5_

---

- [ ] 2. FeedViewModel に履歴管理機能を追加する
- [x] 2.1 FeedViewModel に履歴状態の管理と初期化ロジックを追加する
  - 閲覧履歴エントリの配列を公開プロパティとして追加し、View から観測できるようにする
  - 初期化時にリポジトリから既存の履歴データを読み込む処理を追加する
  - _Requirements: 4.3_

- [x] 2.2 記事を開いたときに履歴を記録する機能を追加する
  - 記事アイテムを受け取って履歴エントリを生成・保存するメソッドを追加する
  - 同一記事（識別子が一致）が既に記録されている場合は閲覧日時を更新して先頭に移動させる
  - 新規エントリは配列の先頭に追加する（閲覧日時降順を維持する）
  - 保存件数が 500 件を超えた場合は末尾（最も古いエントリ）から削除する
  - 操作後にリポジトリへの保存を実行する
  - フィード名が空の場合は URL ホスト名を代替として使用する
  - _Requirements: 1.1, 1.2, 1.3, 1.5, 3.2_

- [x] 2.3 履歴の削除機能を追加する
  - 特定の1件を削除するメソッドを追加し、識別子が一致するエントリのみを除去する
  - すべての履歴を削除するメソッドを追加し、空の状態をリポジトリに保存する
  - それぞれの操作後にリポジトリへの保存を実行して画面状態を同期させる
  - _Requirements: 5.4, 5.5_

---

- [ ] 3. (P) 閲覧履歴画面（HistoryView）を実装する
  - Task 1 完了後、Task 2 と並行して実装可能（FeedViewModel 拡張とは別ファイル）

- [x] 3.1 (P) 閲覧履歴の一覧表示 UI を作成する
  - 閲覧日時降順に並んだ履歴エントリをリスト形式で表示する画面を新規作成する
  - 各エントリに記事タイトル・フィード名・閲覧日時（`yyyy/MM/dd HH:mm` 形式）を表示する
  - エントリが0件の場合は画面中央に「閲覧履歴はありません」というメッセージを表示する
  - データ読み込み中はインジケーターを表示する
  - View はデータとコールバックを受け取るだけでビジネスロジックを持たない設計にする
  - ファイル末尾に `#Preview` を記述してプレビューを動作させる
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3.2 (P) 履歴エントリから記事を再オープンする機能を実装する
  - 各エントリの行がクリック可能なボタンとして機能するよう実装する
  - クリック時に外部コールバック経由で呼び出し元へエントリを通知する
  - リンク URL が無効または空のエントリはクリック不可のスタイルで表示する
  - Task 3.1 との同一ファイル編集となるため、順序は 3.1 → 3.2 で実施する
  - _Requirements: 3.1, 3.3_

- [x] 3.3 (P) 履歴の削除 UI を実装する
  - 「すべて削除」ボタンをツールバーに追加し、外部コールバック経由で全削除を通知する
  - 「すべて削除」クリック時は確認ダイアログを表示し、ユーザーが明示的に確認してから削除を実行する
  - 各エントリを右クリックしたときのコンテキストメニューに「この履歴を削除」を追加する
  - 「この履歴を削除」選択時は外部コールバック経由で対象エントリを通知する
  - Task 3.1 との同一ファイル編集となるため、順序は 3.1 → 3.3 で実施する
  - _Requirements: 5.1, 5.2, 5.3_

---

- [ ] 4. アプリへの統合を完成させる
  - Task 2 と Task 3 の完了を前提とする統合フェーズ

- [x] 4.1 RssView に記事オープンコールバックを追加する
  - 記事カードがクリックされたときに、クリックされた記事アイテムを呼び出し元へ通知するコールバックプロパティを追加する
  - 既存のブラウザ起動処理は維持したまま、コールバック呼び出しを追加する
  - `#Preview` に新しいプロパティのダミー実装を追加してプレビューが壊れないようにする
  - _Requirements: 1.1_

- [x] 4.2 ContentView に履歴タブを追加してアプリ全体を接続する
  - `tab` 列挙型に履歴タブのケースを追加する
  - TabView に `HistoryView` を追加し、タブアイコンに `clock` (SF Symbols) を使用する
  - `HistoryView` へ履歴エントリ・オープン・削除・全削除の各コールバックを接続する
  - `RssView` の新しいコールバックに履歴記録メソッドを接続する
  - _Requirements: 1.1, 3.1, 3.2, 4.1, 4.2, 4.3, 5.1, 5.3, 5.4_

---

- [ ] 5. テストを実装する

- [x] 5.1 (P) 永続化層のユニットテストを実装する
  - 保存して読み込むと同一データが復元されることを検証する
  - デコード失敗時に空の履歴が返ることを検証する
  - _Requirements: 1.4, 5.5_

- [x] 5.2 (P) FeedViewModel の履歴機能ユニットテストを実装する
  - 同一記事を2回記録しても件数が増えず閲覧日時が更新されることを検証する
  - 501件目の記録後に件数が 500 を超えないことを検証する
  - 全削除後に履歴が空配列になることを検証する
  - 個別削除で指定したエントリのみ削除され他が残ることを検証する
  - _Requirements: 1.3, 1.5, 5.4, 5.5_
